import { Directive, Output, PLATFORM_ID, NgZone, inject, input, } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { Subject, BehaviorSubject, Observable, defer } from 'rxjs';
import { filter, switchMap } from 'rxjs/operators';
import { AnimationLoader } from './animation-loader';
import * as i0 from "@angular/core";
export class BaseDirective {
    constructor() {
        this.options = input(null);
        this.containerClass = input(null);
        this.styles = input(null);
        /**
         * `animationCreated` is dispatched after calling `loadAnimation`.
         */
        this.animationCreated = this.getAnimationItem();
        /**
         * `complete` is dispatched after completing the last frame.
         */
        this.complete = this.awaitAnimationItemAndStartListening('complete');
        /**
         * `loopComplete` is dispatched after completing the frame loop.
         */
        this.loopComplete = this.awaitAnimationItemAndStartListening('loopComplete');
        /**
         * `enterFrame` is dispatched after entering the new frame.
         */
        this.enterFrame = this.awaitAnimationItemAndStartListening('enterFrame');
        /**
         * `segmentStart` is dispatched when the new segment is adjusted.
         */
        this.segmentStart = this.awaitAnimationItemAndStartListening('segmentStart');
        /**
         * Original event name is `config_ready`. `config_ready` is dispatched
         * after the needed renderer is configured.
         */
        this.configReady = this.awaitAnimationItemAndStartListening('config_ready');
        /**
         * Original event name is `data_ready`. `data_ready` is dispatched
         * when all parts of the animation have been loaded.
         */
        this.dataReady = this.awaitAnimationItemAndStartListening('data_ready');
        /**
         * Original event name is `DOMLoaded`. `DOMLoaded` is dispatched
         * when elements have been added to the DOM.
         */
        this.domLoaded = this.awaitAnimationItemAndStartListening('DOMLoaded');
        /**
         * `destroy` will be dispatched when the component gets destroyed,
         * it's handy for releasing resources.
         */
        this.destroy = this.awaitAnimationItemAndStartListening('destroy');
        /**
         * `error` will be dispatched if the Lottie player could not render
         * some frame or parse config.
         */
        this.error = this.awaitAnimationItemAndStartListening('error');
        this.ngZone = inject(NgZone);
        this.isBrowser = isPlatformBrowser(inject(PLATFORM_ID));
        this.animationLoader = inject(AnimationLoader);
        this.loadAnimation$ = new Subject();
        this.animationItem$ = new BehaviorSubject(null);
        this.setupLoadAnimationListener();
    }
    ngOnDestroy() {
        this.destroyAnimation();
    }
    loadAnimation(changes, container) {
        this.ngZone.runOutsideAngular(() => this.loadAnimation$.next([changes, container]));
    }
    getAnimationItem() {
        return defer(() => this.animationItem$).pipe(filter((animationItem) => animationItem !== null));
    }
    awaitAnimationItemAndStartListening(name) {
        return this.getAnimationItem().pipe(switchMap(animationItem => 
        // `fromEvent` will try to call `removeEventListener` when `unsubscribe()` is invoked.
        // The problem is that `ngOnDestroy()` is called before Angular unsubscribes from
        // `@Output()` properties, thus `animationItem` will be `null` already, also `lottie-web`
        // removes event listeners when calling `destroy()`.
        new Observable(observer => {
            this.ngZone.runOutsideAngular(() => {
                animationItem.addEventListener(name, event => {
                    this.ngZone.runOutsideAngular(() => {
                        observer.next(event);
                    });
                });
            });
        })));
    }
    setupLoadAnimationListener() {
        const loadAnimation$ = this.loadAnimation$.pipe(filter(([changes]) => this.isBrowser && changes.options !== undefined));
        loadAnimation$
            .pipe(switchMap(([changes, container]) => {
            this.destroyAnimation();
            return this.animationLoader.loadAnimation(this.animationLoader.resolveOptions(changes.options.currentValue, container));
        }), takeUntilDestroyed())
            .subscribe(animationItem => {
            this.ngZone.run(() => this.animationItem$.next(animationItem));
        });
    }
    destroyAnimation() {
        const animationItem = this.animationItem$.getValue();
        // The `ng-lottie` component or the `lottie` directive can be destroyed
        // before the `animationItem` is set, thus it will fail with
        // `Cannot read property 'destroy' of null`.
        // Potentially it can happen if the directive gets destroyed before change
        // detection is run.
        if (animationItem === null) {
            return;
        }
        // `destroy()` will remove all events listeners.
        animationItem.destroy();
        this.animationItem$.next(null);
    }
    /** @nocollapse */ static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BaseDirective, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    /** @nocollapse */ static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "17.1.0", version: "17.2.4", type: BaseDirective, selector: "[lottie]", inputs: { options: { classPropertyName: "options", publicName: "options", isSignal: true, isRequired: false, transformFunction: null }, containerClass: { classPropertyName: "containerClass", publicName: "containerClass", isSignal: true, isRequired: false, transformFunction: null }, styles: { classPropertyName: "styles", publicName: "styles", isSignal: true, isRequired: false, transformFunction: null } }, outputs: { animationCreated: "animationCreated", complete: "complete", loopComplete: "loopComplete", enterFrame: "enterFrame", segmentStart: "segmentStart", configReady: "configReady", dataReady: "dataReady", domLoaded: "domLoaded", destroy: "destroy", error: "error" }, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BaseDirective, decorators: [{
            type: Directive,
            args: [{ selector: '[lottie]' }]
        }], ctorParameters: () => [], propDecorators: { animationCreated: [{
                type: Output
            }], complete: [{
                type: Output
            }], loopComplete: [{
                type: Output
            }], enterFrame: [{
                type: Output
            }], segmentStart: [{
                type: Output
            }], configReady: [{
                type: Output
            }], dataReady: [{
                type: Output
            }], domLoaded: [{
                type: Output
            }], destroy: [{
                type: Output
            }], error: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25neC1sb3R0aWUvc3JjL2xpYi9iYXNlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULE1BQU0sRUFDTixXQUFXLEVBRVgsTUFBTSxFQUNOLE1BQU0sRUFFTixLQUFLLEdBQ04sTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDcEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBY25ELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQzs7QUFHckQsTUFBTSxPQUFPLGFBQWE7SUE0RXhCO1FBM0VBLFlBQU8sR0FBRyxLQUFLLENBQTBCLElBQUksQ0FBQyxDQUFDO1FBRS9DLG1CQUFjLEdBQUcsS0FBSyxDQUFnQixJQUFJLENBQUMsQ0FBQztRQUU1QyxXQUFNLEdBQUcsS0FBSyxDQUFzQyxJQUFJLENBQUMsQ0FBQztRQUUxRDs7V0FFRztRQUNnQixxQkFBZ0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUU5RDs7V0FFRztRQUNnQixhQUFRLEdBQ3pCLElBQUksQ0FBQyxtQ0FBbUMsQ0FBa0IsVUFBVSxDQUFDLENBQUM7UUFFeEU7O1dBRUc7UUFDZ0IsaUJBQVksR0FDN0IsSUFBSSxDQUFDLG1DQUFtQyxDQUFzQixjQUFjLENBQUMsQ0FBQztRQUVoRjs7V0FFRztRQUNnQixlQUFVLEdBQzNCLElBQUksQ0FBQyxtQ0FBbUMsQ0FBb0IsWUFB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TUFBTTtnQkFNWSxPQUFPO3NCQUF6QixNQUFNO2dCQU1ZLEtBQUs7c0JBQXZCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIE91dHB1dCxcbiAgUExBVEZPUk1fSUQsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIE5nWm9uZSxcbiAgaW5qZWN0LFxuICBPbkRlc3Ryb3ksXG4gIGlucHV0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IHRha2VVbnRpbERlc3Ryb3llZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvcnhqcy1pbnRlcm9wJztcblxuaW1wb3J0IHsgU3ViamVjdCwgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBkZWZlciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIEFuaW1hdGlvbk9wdGlvbnMsXG4gIEJNQ29tcGxldGVFdmVudCxcbiAgQk1Db21wbGV0ZUxvb3BFdmVudCxcbiAgQk1FbnRlckZyYW1lRXZlbnQsXG4gIEJNU2VnbWVudFN0YXJ0RXZlbnQsXG4gIEJNRGVzdHJveUV2ZW50LFxuICBCTVJlbmRlckZyYW1lRXJyb3JFdmVudCxcbiAgQk1Db25maWdFcnJvckV2ZW50LFxuICBBbmltYXRpb25JdGVtLFxuICBBbmltYXRpb25FdmVudE5hbWUsXG59IGZyb20gJy4vc3ltYm9scyc7XG5pbXBvcnQgeyBBbmltYXRpb25Mb2FkZXIgfSBmcm9tICcuL2FuaW1hdGlvbi1sb2FkZXInO1xuXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbbG90dGllXScgfSlcbmV4cG9ydCBjbGFzcyBCYXNlRGlyZWN0aXZlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgb3B0aW9ucyA9IGlucHV0PEFuaW1hdGlvbk9wdGlvbnMgfCBudWxsPihudWxsKTtcblxuICBjb250YWluZXJDbGFzcyA9IGlucHV0PHN0cmluZyB8IG51bGw+KG51bGwpO1xuXG4gIHN0eWxlcyA9IGlucHV0PFBhcnRpYWw8Q1NTU3R5bGVEZWNsYXJhdGlvbj4gfCBudWxsPihudWxsKTtcblxuICAvKipcbiAgICogYGFuaW1hdGlvbkNyZWF0ZWRgIGlzIGRpc3BhdGNoZWQgYWZ0ZXIgY2FsbGluZyBgbG9hZEFuaW1hdGlvbmAuXG4gICAqL1xuICBAT3V0cHV0KCkgcmVhZG9ubHkgYW5pbWF0aW9uQ3JlYXRlZCA9IHRoaXMuZ2V0QW5pbWF0aW9uSXRlbSgpO1xuXG4gIC8qKlxuICAgKiBgY29tcGxldGVgIGlzIGRpc3BhdGNoZWQgYWZ0ZXIgY29tcGxldGluZyB0aGUgbGFzdCBmcmFtZS5cbiAgICovXG4gIEBPdXRwdXQoKSByZWFkb25seSBjb21wbGV0ZSA9XG4gICAgdGhpcy5hd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzxCTUNvbXBsZXRlRXZlbnQ+KCdjb21wbGV0ZScpO1xuXG4gIC8qKlxuICAgKiBgbG9vcENvbXBsZXRlYCBpcyBkaXNwYXRjaGVkIGFmdGVyIGNvbXBsZXRpbmcgdGhlIGZyYW1lIGxvb3AuXG4gICAqL1xuICBAT3V0cHV0KCkgcmVhZG9ubHkgbG9vcENvbXBsZXRlID1cbiAgICB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPEJNQ29tcGxldGVMb29wRXZlbnQ+KCdsb29wQ29tcGxldGUnKTtcblxuICAvKipcbiAgICogYGVudGVyRnJhbWVgIGlzIGRpc3BhdGNoZWQgYWZ0ZXIgZW50ZXJpbmcgdGhlIG5ldyBmcmFtZS5cbiAgICovXG4gIEBPdXRwdXQoKSByZWFkb25seSBlbnRlckZyYW1lID1cbiAgICB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPEJNRW50ZXJGcmFtZUV2ZW50PignZW50ZXJGcmFtZScpO1xuXG4gIC8qKlxuICAgKiBgc2VnbWVudFN0YXJ0YCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIG5ldyBzZWdtZW50IGlzIGFkanVzdGVkLlxuICAgKi9cbiAgQE91dHB1dCgpIHJlYWRvbmx5IHNlZ21lbnRTdGFydCA9XG4gICAgdGhpcy5hd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzxCTVNlZ21lbnRTdGFydEV2ZW50Pignc2VnbWVudFN0YXJ0Jyk7XG5cbiAgLyoqXG4gICAqIE9yaWdpbmFsIGV2ZW50IG5hbWUgaXMgYGNvbmZpZ19yZWFkeWAuIGBjb25maWdfcmVhZHlgIGlzIGRpc3BhdGNoZWRcbiAgICogYWZ0ZXIgdGhlIG5lZWRlZCByZW5kZXJlciBpcyBjb25maWd1cmVkLlxuICAgKi9cbiAgQE91dHB1dCgpIHJlYWRvbmx5IGNvbmZpZ1JlYWR5ID0gdGhpcy5hd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzx2b2lkPignY29uZmlnX3JlYWR5Jyk7XG5cbiAgLyoqXG4gICAqIE9yaWdpbmFsIGV2ZW50IG5hbWUgaXMgYGRhdGFfcmVhZHlgLiBgZGF0YV9yZWFkeWAgaXMgZGlzcGF0Y2hlZFxuICAgKiB3aGVuIGFsbCBwYXJ0cyBvZiB0aGUgYW5pbWF0aW9uIGhhdmUgYmVlbiBsb2FkZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgcmVhZG9ubHkgZGF0YVJlYWR5ID0gdGhpcy5hd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzx2b2lkPignZGF0YV9yZWFkeScpO1xuXG4gIC8qKlxuICAgKiBPcmlnaW5hbCBldmVudCBuYW1lIGlzIGBET01Mb2FkZWRgLiBgRE9NTG9hZGVkYCBpcyBkaXNwYXRjaGVkXG4gICAqIHdoZW4gZWxlbWVudHMgaGF2ZSBiZWVuIGFkZGVkIHRvIHRoZSBET00uXG4gICAqL1xuICBAT3V0cHV0KCkgcmVhZG9ubHkgZG9tTG9hZGVkID0gdGhpcy5hd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzx2b2lkPignRE9NTG9hZGVkJyk7XG5cbiAgLyoqXG4gICAqIGBkZXN0cm95YCB3aWxsIGJlIGRpc3BhdGNoZWQgd2hlbiB0aGUgY29tcG9uZW50IGdldHMgZGVzdHJveWVkLFxuICAgKiBpdCdzIGhhbmR5IGZvciByZWxlYXNpbmcgcmVzb3VyY2VzLlxuICAgKi9cbiAgQE91dHB1dCgpIHJlYWRvbmx5IGRlc3Ryb3kgPSB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPEJNRGVzdHJveUV2ZW50PignZGVzdHJveScpO1xuXG4gIC8qKlxuICAgKiBgZXJyb3JgIHdpbGwgYmUgZGlzcGF0Y2hlZCBpZiB0aGUgTG90dGllIHBsYXllciBjb3VsZCBub3QgcmVuZGVyXG4gICAqIHNvbWUgZnJhbWUgb3IgcGFyc2UgY29uZmlnLlxuICAgKi9cbiAgQE91dHB1dCgpIHJlYWRvbmx5IGVycm9yID0gdGhpcy5hd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzxcbiAgICBCTVJlbmRlckZyYW1lRXJyb3JFdmVudCB8IEJNQ29uZmlnRXJyb3JFdmVudFxuICA+KCdlcnJvcicpO1xuXG4gIHByaXZhdGUgbmdab25lID0gaW5qZWN0KE5nWm9uZSk7XG4gIHByaXZhdGUgaXNCcm93c2VyID0gaXNQbGF0Zm9ybUJyb3dzZXIoaW5qZWN0KFBMQVRGT1JNX0lEKSk7XG5cbiAgcHJpdmF0ZSBhbmltYXRpb25Mb2FkZXIgPSBpbmplY3QoQW5pbWF0aW9uTG9hZGVyKTtcblxuICBwcml2YXRlIGxvYWRBbmltYXRpb24kID0gbmV3IFN1YmplY3Q8W1NpbXBsZUNoYW5nZXMsIEhUTUxFbGVtZW50XT4oKTtcbiAgcHJpdmF0ZSBhbmltYXRpb25JdGVtJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8QW5pbWF0aW9uSXRlbSB8IG51bGw+KG51bGwpO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuc2V0dXBMb2FkQW5pbWF0aW9uTGlzdGVuZXIoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZGVzdHJveUFuaW1hdGlvbigpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGxvYWRBbmltYXRpb24oY2hhbmdlczogU2ltcGxlQ2hhbmdlcywgY29udGFpbmVyOiBIVE1MRWxlbWVudCk6IHZvaWQge1xuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHRoaXMubG9hZEFuaW1hdGlvbiQubmV4dChbY2hhbmdlcywgY29udGFpbmVyXSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBbmltYXRpb25JdGVtKCk6IE9ic2VydmFibGU8QW5pbWF0aW9uSXRlbT4ge1xuICAgIHJldHVybiBkZWZlcigoKSA9PiB0aGlzLmFuaW1hdGlvbkl0ZW0kKS5waXBlKFxuICAgICAgZmlsdGVyKFxuICAgICAgICAoYW5pbWF0aW9uSXRlbTogQW5pbWF0aW9uSXRlbSB8IG51bGwpOiBhbmltYXRpb25JdGVtIGlzIEFuaW1hdGlvbkl0ZW0gPT5cbiAgICAgICAgICBhbmltYXRpb25JdGVtICE9PSBudWxsLFxuICAgICAgKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzxUPihuYW1lOiBBbmltYXRpb25FdmVudE5hbWUpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRBbmltYXRpb25JdGVtKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcChcbiAgICAgICAgYW5pbWF0aW9uSXRlbSA9PlxuICAgICAgICAgIC8vIGBmcm9tRXZlbnRgIHdpbGwgdHJ5IHRvIGNhbGwgYHJlbW92ZUV2ZW50TGlzdGVuZXJgIHdoZW4gYHVuc3Vic2NyaWJlKClgIGlzIGludm9rZWQuXG4gICAgICAgICAgLy8gVGhlIHByb2JsZW0gaXMgdGhhdCBgbmdPbkRlc3Ryb3koKWAgaXMgY2FsbGVkIGJlZm9yZSBBbmd1bGFyIHVuc3Vic2NyaWJlcyBmcm9tXG4gICAgICAgICAgLy8gYEBPdXRwdXQoKWAgcHJvcGVydGllcywgdGh1cyBgYW5pbWF0aW9uSXRlbWAgd2lsbCBiZSBgbnVsbGAgYWxyZWFkeSwgYWxzbyBgbG90dGllLXdlYmBcbiAgICAgICAgICAvLyByZW1vdmVzIGV2ZW50IGxpc3RlbmVycyB3aGVuIGNhbGxpbmcgYGRlc3Ryb3koKWAuXG4gICAgICAgICAgbmV3IE9ic2VydmFibGU8VD4ob2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICAgICAgICBhbmltYXRpb25JdGVtLmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZXZlbnQgYXMgVCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSksXG4gICAgICApLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwTG9hZEFuaW1hdGlvbkxpc3RlbmVyKCk6IHZvaWQge1xuICAgIGNvbnN0IGxvYWRBbmltYXRpb24kID0gdGhpcy5sb2FkQW5pbWF0aW9uJC5waXBlKFxuICAgICAgZmlsdGVyKChbY2hhbmdlc10pID0+IHRoaXMuaXNCcm93c2VyICYmIGNoYW5nZXMub3B0aW9ucyAhPT0gdW5kZWZpbmVkKSxcbiAgICApO1xuXG4gICAgbG9hZEFuaW1hdGlvbiRcbiAgICAgIC5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKFtjaGFuZ2VzLCBjb250YWluZXJdKSA9PiB7XG4gICAgICAgICAgdGhpcy5kZXN0cm95QW5pbWF0aW9uKCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0aW9uTG9hZGVyLmxvYWRBbmltYXRpb24oXG4gICAgICAgICAgICB0aGlzLmFuaW1hdGlvbkxvYWRlci5yZXNvbHZlT3B0aW9ucyhjaGFuZ2VzLm9wdGlvbnMuY3VycmVudFZhbHVlLCBjb250YWluZXIpLFxuICAgICAgICAgICk7XG4gICAgICAgIH0pLFxuICAgICAgICB0YWtlVW50aWxEZXN0cm95ZWQoKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoYW5pbWF0aW9uSXRlbSA9PiB7XG4gICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB0aGlzLmFuaW1hdGlvbkl0ZW0kLm5leHQoYW5pbWF0aW9uSXRlbSkpO1xuICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGRlc3Ryb3lBbmltYXRpb24oKTogdm9pZCB7XG4gICAgY29uc3QgYW5pbWF0aW9uSXRlbSA9IHRoaXMuYW5pbWF0aW9uSXRlbSQuZ2V0VmFsdWUoKTtcbiAgICAvLyBUaGUgYG5nLWxvdHRpZWAgY29tcG9uZW50IG9yIHRoZSBgbG90dGllYCBkaXJlY3RpdmUgY2FuIGJlIGRlc3Ryb3llZFxuICAgIC8vIGJlZm9yZSB0aGUgYGFuaW1hdGlvbkl0ZW1gIGlzIHNldCwgdGh1cyBpdCB3aWxsIGZhaWwgd2l0aFxuICAgIC8vIGBDYW5ub3QgcmVhZCBwcm9wZXJ0eSAnZGVzdHJveScgb2YgbnVsbGAuXG4gICAgLy8gUG90ZW50aWFsbHkgaXQgY2FuIGhhcHBlbiBpZiB0aGUgZGlyZWN0aXZlIGdldHMgZGVzdHJveWVkIGJlZm9yZSBjaGFuZ2VcbiAgICAvLyBkZXRlY3Rpb24gaXMgcnVuLlxuICAgIGlmIChhbmltYXRpb25JdGVtID09PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gYGRlc3Ryb3koKWAgd2lsbCByZW1vdmUgYWxsIGV2ZW50cyBsaXN0ZW5lcnMuXG4gICAgYW5pbWF0aW9uSXRlbS5kZXN0cm95KCk7XG4gICAgdGhpcy5hbmltYXRpb25JdGVtJC5uZXh0KG51bGwpO1xuICB9XG59XG4iXX0=